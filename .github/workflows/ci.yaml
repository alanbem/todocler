name: CI
on: [push]
jobs:
  validate-composer:
    name: composer validate
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Run composer validate
        run: docker-compose run --rm --no-deps php composer validate --strict --no-interaction --ansi
  run-php-cs-fixer:
    name: php-cs-fixer
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: docker-compose run --rm php composer install --no-interaction --optimize-autoloader --ansi
      - name: Run php-cs-fixer
        run: docker-compose run --rm --no-deps php bin/php-cs-fixer fix --diff --dry-run --ansi --config=.php_cs.dist
  run-phpunit:
    name: phpunit
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: docker-compose run --rm php composer install --no-interaction --optimize-autoloader --ansi
      - name: Run phpunit
        run: docker-compose run --rm php xphp bin/phpunit --color=always --configuration=phpunit.xml.dist
      - name: Upload coverage report to codecov.io
        uses: codecov/codecov-action@v1
        with:
          files: ./var/phpunit/clover.xml
          fail_ci_if_error: true
          verbose: true
  run-rector:
    name: rector
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: docker-compose run --rm php composer install --no-interaction --optimize-autoloader --ansi
      - name: Run rector
        run: docker-compose run --rm --no-deps php bin/rector --no-progress-bar --dry-run --ansi
  run-deptrac:
    name: deptrac
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Install dependencies
        run: docker-compose run --rm php composer install --no-interaction --optimize-autoloader --ansi
      - name: Run deptrac
        run: docker-compose run --rm --no-deps php bin/deptrac --formatter=github-actions --no-progress --no-interaction
